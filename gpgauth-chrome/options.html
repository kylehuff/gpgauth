<html>
<head>
<title>gpgAuth Chrome Options</title>
<link type="text/css" href="jquery/css/ui-darkness/jquery-ui-1.8.4.custom.css" rel="stylesheet" />
<script type="text/javascript" src="jquery/js/jquery-1.4.2.min.js"></script>
<script type="text/javascript" src="jquery/js/jquery-ui-1.8.4.custom.min.js"></script>
<script type="text/javascript">
$(function(){

    $("#private_keylist").accordion({ header: "h3.private_keylist", alwaysOpen: false,
                autoheight:false, clearStyle:true, active:".ui-accordion-left",
                collapsible: true });
    $("#public_keylist").accordion({ header: "h3.keylist", alwaysOpen: false,
                autoheight:false, clearStyle:true, active:".ui-accordion-left",
                collapsible: true });
    $(".uidlist").accordion({ header: "h3", alwaysOpen: false,
                autoheight:false, clearStyle:true, active:".ui-accordion-left",
                collapsible: true });
    $('#tabs').tabs();
    $(".check").button();
    $('.keylist').click(function(e){
            uidcontainer = e.target.parentNode.parentNode.children[1];
            uidlist = $(uidcontainer).children('[class=uid]');
            ext = chrome.extension.getBackgroundPage();
            var pkeylist = JSON.parse(ext.plugin.getPrivateKeyList());
            if (!pkeylist) {
                // if the parsing failed, create an empty keylist
                pkeylist = {};
            }
            var keylist = JSON.parse(ext.plugin.getKeyList());
            if (!keylist) {
                // if the parsing failed, create an empty keylist
                keylist = {};
            }
            key = uidcontainer.id;          
            GAUTrust = -100;
            uidlist.each(function(event, uidobj) {
                uid = uidobj.id;
                for (privateKeyId in pkeylist) {
                    if (!pkeylist[privateKeyId].keystatus){
                        pkey_status = 0;
                        pkey_status += parseInt(keylist[key].expired)
                        pkey_status += parseInt(keylist[key].disabled)
                        pkey_status += parseInt(keylist[key].invalid)
                        pkey_status += parseInt(keylist[key].revoked)
                        GAUTrust = (pkey_status || keylist[key].uids[0].signatures.length < 2) ? '?' : ext.plugin.verifyDomainKey(keylist[key].uids[uid].uid, keylist[key].uids[uid].uid, privateKeyId);
                        if (GAUTrust == '?' || GAUTrust > -1) {
                            break;
                        }
                    }
                }
                $(uidobj).find('.trust')[0].innerHTML = "Trust: " + GAUTrust;
            });
            // for each UID, get trust assignement...
    });

});
</script>
<style>
body{ font: 62.5% "Trebuchet MS", sans-serif;}
#header_image {
    height: 74px;
    width: 74px;
    padding-right: 6px;
}
.invalid-key .ui-accordion-header, .disabled .ui-accordion-header {
    text-decoration: line-through;
    color: #E31;
}
.trust {
    right: 0;
    float: right;
    position: relative;
    text-decoration: none;
}
.keydetails {
    font-size: 14px;
    font-weight: bold;
    width: 100%;
    border: solid 1px #181;
    padding:4px;
    margin: 2px;
    background: #0078a3  url('images/menumask.png') repeat-x;
    text-align: left;
    color: #ffffff;
}
.keydetails span {
    margin-right: 20px;
}
.invalid-key .keydetails, .disabled .keydetails {
    background-color: #F31;
    border: solid 1px #F11;
}
.keydetails .dh {
    color: #000;
    font-size: 14px;
}
.keydetails hr {
    margin: 0;
    right: 0;
    margin-left: 100px;
    position:relative;
    top:-10px;
    padding:0;
}
.keydetails h4 {
    color: #363636;
    margin: 0;
    display: inline;
}
</style>
</head>
<body>

<div id="header"><img src="images/gpgauth-128.png" id="header_image"/><h1 style="display: inline; top: -18px; position: relative;">gpgAuth Options</h1></div>


<div id="tabs">
    <ul>
        <li><a href="#tabs-1">General</a></li>
        <li><a href="#tabs-2">Private Keys</a></li>
        <li><a href="#tabs-3">Public Keys</a></li>
    </ul>
    <div id="tabs-1">
        Phasellus mattis tincidunt nibh. Cras orci urna, blandit id, pretium vel, aliquet ornare, felis. Maecenas scelerisque sem non nis
    </div>
    <div id="tabs-2">
        <div id="private_keylist">
            <div class="ui-accordion-left"></div>
        </div>
    </div>
    <div id="tabs-3">
        <div id="public_keylist">
            <div class="ui-accordion-left"></div>
        </div>
    </div>
<script>

    ext = chrome.extension.getBackgroundPage();
    var pkeylist = JSON.parse(ext.plugin.getPrivateKeyList());
    if (!pkeylist) {
        // if the parsing failed, create an empty keylist
        pkeylist = {};
    }

    var keylist = JSON.parse(ext.plugin.getKeyList());
    if (!keylist) {
        // if the parsing failed, create an empty keylist
        keylist = {};
    }

    enabled_keys = ext.gpgauth_prefs.enabled_keys.get();

    private_keylist = document.getElementById('private_keylist');    
    
    var prev_key = null;
    for (key in pkeylist){
        keyobj = document.createElement('div');
        if (parseInt(keylist[key].disabled) == 1)
            keyobj.className = 'disabled';
        if (parseInt(keylist[key].expired) == 1)
            keyobj.className = 'invalid-key';
        if (parseInt(keylist[key].invalid) == 1)
            keyobj.className = 'invalid-key';
        keyobj.className += ' primary_key';
        keyobj.innerHTML = "<h3 class='private_keylist'><a href='#'>" + keylist[key].name + "</a></h3>";
        private_keylist.appendChild(keyobj);
        keylist[key].nuids = 0;
        for (uid in keylist[key].uids) {
            keylist[key].nuids += 1;
        }
        uidlist = document.createElement('div');
        uidlist.setAttribute('style', 'width: 96%;');
        uidlist.setAttribute('class', 'uidlist');
        uidlist.setAttribute('id', key);
        created_date = new Date(pkeylist[key].subkeys[0].created * 1000).toJSON().substring(0, 10);
        expiry = (pkeylist[key].subkeys[0].expires == 0) ? 'Never' : new Date(pkeylist[key].subkeys[0].expires * 1000).toJSON();
        if (pkeylist[key].subkeys[0].expires > 0) {
            expiry = (Math.round(new Date().getTime()/1000.0) > parseInt(pkeylist[key].subkeys[0].expires)) ? "Expired" : expiry.substring(0, 10);
        }
        enabled = (key in enabled_keys) ? " checked" : "";
        uidlist.innerHTML = "<div class='keydetails'><span class='dh'>Key Details</span><hr/>" +
            "<span><h4>KeyID:</h4> 0x" + key.substr(-8) + "</span><span><h4>Key Created:</h4> " + created_date + "</span><span><h4>Expires:</h4> " + expiry + "</span><span><h4>UIDs:</h4> " + keylist[key].nuids + "</span><br/>" +
            "<h4>Fingerpint</h4>: " + pkeylist[key].fingerprint +
            "<br/><br/>" +
            "<span class='dh'>Key Options</span><hr/>" +
            "<input class='check'" + enabled + 
            " onchange=\"(this.checked) ? ext.gpgauth_prefs.enabled_keys.add('" + key + "') : ext.gpgauth_prefs.enabled_keys.remove('" + key + "');\">";
            "</div>";
        for (uid in keylist[key].uids) {
            uidobj = document.createElement('div');
            uidobj.setAttribute('class', 'uid');
            uidobj.setAttribute('id', uid);
            if (parseInt(keylist[key].expired) == 1)
                uidobj.className = 'invalid-key';
            email = (keylist[key].uids[uid].email.length > 1) ? "  -  &lt;" + keylist[key].uids[uid].email + "&gt;" :
                "  - (no email address provided)";
            console.log(keylist[key].uids[uid].validity);
            uidobj.innerHTML += "<h3 class='uidlist'><a href='#'><span style='margin:0; width: 50%'>" + keylist[key].uids[uid].uid + email + "</span><span class='trust' style='text-decoration: none;'>" + keylist[key].uids[uid].validity + "</span></a></h3>";
            signed = 0;
            nd_trust = false;
            uidobjbody = document.createElement('div');
            for (sig in keylist[key].uids[uid].signatures) {
                sig_keyid = keylist[key].uids[uid].signatures[sig]
                if (sig_keyid in keylist || nd_trust) {
                    if (sig_keyid in pkeylist) {
                        signed = 1;
                    }
                    signature_id = Math.random().toString().substring(3);
                    uidobjbody.innerHTML += "<div id='" + signature_id + "' style='clear:right;'>" +
                        "<img style='height:14px;' src='images/badges/stock_signature.png'> " + 
                        keylist[sig_keyid].name + " " + sig_keyid + "</div>";
                }
            }
            uidobj.appendChild(uidobjbody);
            uidlist.appendChild(uidobj);
        }
        keyobj.appendChild(uidlist);
    }
    

    public_keylist = document.getElementById('public_keylist');
    var prev_key = null;
    for (key in keylist){
        if (key in pkeylist) {
            continue;
        }
        keyobj = document.createElement('div');
        if (parseInt(keylist[key].disabled) == 1)
            keyobj.className = 'disabled';
        if (parseInt(keylist[key].expired) == 1)
            keyobj.className = 'invalid-key';
        if (parseInt(keylist[key].invalid) == 1)
            keyobj.className = 'invalid-key';
        keyobj.className += ' primary_key';
        keyobj.innerHTML = "<h3 class='keylist'><a href='#'>" + keylist[key].name + "</a></h3>";
        public_keylist.appendChild(keyobj);
        keylist[key].nuids = 0;
        for (uid in keylist[key].uids) {
            keylist[key].nuids += 1;
        }
        uidlist = document.createElement('div');
        uidlist.setAttribute('style', 'width: 96%;');
        uidlist.setAttribute('class', 'uidlist');
        uidlist.setAttribute('id', key);
        created_date = new Date(keylist[key].subkeys[0].created * 1000).toJSON().substring(0, 10);
        expiry = (keylist[key].subkeys[0].expires == 0) ? 'Never' : new Date(keylist[key].subkeys[0].expires * 1000).toJSON();
        if (keylist[key].subkeys[0].expires > 0) {
            expiry = (Math.round(new Date().getTime()/1000.0) > parseInt(keylist[key].subkeys[0].expires)) ? "Expired" : expiry.substring(0, 10);
        }
        uidlist.innerHTML = "<div class='keydetails'><span class='dh'>Key Details</span><hr/>" +
            "<span><h4>KeyID:</h4> 0x" + key.substr(-8) + "</span><span><h4>Key Created:</h4> " + created_date + "</span><span><h4>Expires:</h4> " + expiry + "</span><span><h4>UIDs:</h4> " + keylist[key].nuids + "</span><br/>" +
            "<h4>Fingerpint</h4>: " + keylist[key].fingerprint +
            "<br/><br/>" +
            "<span class='dh'>Key Options</span><hr/>" +
            "</div>";
        for (uid in keylist[key].uids) {
            uidobj = document.createElement('div');
            uidobj.setAttribute('class', 'uid');
            uidobj.setAttribute('id', uid);
            if (parseInt(keylist[key].expired) == 1)
                uidobj.className = 'invalid-key';
            email = (keylist[key].uids[uid].email.length > 1) ? "  -  &lt;" + keylist[key].uids[uid].email + "&gt;" :
                "  - (no email address provided)";
            uidobj.innerHTML += "<h3 class='uidlist'><a href='#'><span style='margin:0; width: 50%'>" + keylist[key].uids[uid].uid + email + "</span><span class='trust' style='text-decoration: none;'><img style='width:15px;' src='images/wait.gif' alt='wait'/></span></a></h3>";
            signed = 0;
            nd_trust = false;
            uidobjbody = document.createElement('div');
            for (sig in keylist[key].uids[uid].signatures) {
                sig_keyid = keylist[key].uids[uid].signatures[sig]
                if (sig_keyid in keylist || nd_trust) {
                    if (sig_keyid in pkeylist) {
                        signed = 1;
                    }
                    signature_id = Math.random().toString().substring(3);
                    uidobjbody.innerHTML += "<div id='" + signature_id + "' style='clear:right;'>" +
                        "<img style='height:14px;' src='images/badges/stock_signature.png'> " + 
                        keylist[sig_keyid].name + " " + sig_keyid + "</div>";
                }
            }
            uidobj.appendChild(uidobjbody);
            uidlist.appendChild(uidobj);
        }
        keyobj.appendChild(uidlist);
    }
</script>
</html>
